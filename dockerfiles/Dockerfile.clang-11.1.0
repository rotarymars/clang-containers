FROM ubuntu:20.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    ninja-build \
    git \
    python3 \
    && rm -rf /var/lib/apt/lists/*

# Clone LLVM project with specific version
WORKDIR /opt
RUN git clone --branch llvmorg-11.1.0 --depth 1 https://github.com/llvm/llvm-project.git

# Build and install clang
WORKDIR /opt/llvm-project
RUN mkdir build && cd build && \
    cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr/local \
    -DLLVM_ENABLE_PROJECTS=clang \
    -DLLVM_TARGETS_TO_BUILD=X86 \
    ../llvm && \
    cmake --build . --target install

# Runtime image
FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    cmake \
    ninja-build \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy clang installation from builder
COPY --from=builder /usr/local /usr/local

# Set up default build directory
WORKDIR /workspace
RUN mkdir -p build

# Default command shows clang version
CMD ["clang", "--version"]
